<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-t" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cadastro de Produtos (Backend Spark)</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 20px; line-height:1.4; background-color:#f8f9fa; }
    .container { max-width: 980px; margin: 0 auto; }
    form { display: grid; gap: 10px; grid-template-columns: 1fr 1fr; align-items: end; margin-bottom: 18px; padding: 16px; border: 1px solid #ddd; border-radius: 8px; background:#fff; }
    label { display:block; font-size: 0.9rem; margin-bottom:4px; font-weight: 500; }
    input { width:100%; padding:8px; border:1px solid #ccc; border-radius:6px; box-sizing: border-box; }
    .full { grid-column: 1 / -1; }
    .actions { display:flex; gap:8px; }
    button { padding:8px 12px; border-radius:6px; border: none; cursor:pointer; font-weight: bold; }
    button.primary { background:#007bff; color:white; }
    button.warn { background:#ffc107; color:#222; }
    button.danger { background:#dc3545; color:white; }
    table { width:100%; border-collapse: collapse; margin-top: 12px; background: white; }
    th, td { padding:10px; border-bottom:1px solid #eee; text-align:left; font-size:0.95rem; }
    tr:hover { background:#f1f1f1; }
    .small { font-size:0.85rem; color:#666; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Cadastro de Produtos</h1>
    <p class="small">Formulário conectado a um backend Java (Spark Framework).</p>

    <form id="produtoForm">
      <div>
        <label for="id">ID (deixe vazio para novo, preencha para atualizar/excluir)</label>
        <input type="text" id="id" name="id" />
      </div>
      <div>
        <label for="nome">Nome do Produto</label>
        <input type="text" id="nome" name="nome" required />
      </div>
      <div>
        <label for="preco">Preço (R$)</label>
        <input type="number" id="preco" name="preco" step="0.01" min="0" required />
      </div>
      <div>
        <label for="quantidade">Quantidade em Estoque</label>
        <input type="number" id="quantidade" name="quantidade" min="0" required />
      </div>
      <div class="full actions">
        <button type="submit" class="primary">Salvar (POST)</button>
        <button type="button" id="btnAtualizar" class="warn">Atualizar (PUT)</button>
        <button type="button" id="btnExcluir" class="danger">Excluir (DELETE)</button>
        <button type="button" id="btnLimpar">Limpar</button>
      </div>
    </form>

    <div id="mensagens" class="small"></div>

    <table id="tabelaProdutos">
      <thead>
        <tr>
          <th>ID</th><th>Nome</th><th>Preço</th><th>Quantidade</th><th>Ações</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    (function(){
      const API_URL = 'http://localhost:4567/api/produtos';
      const form = document.getElementById('produtoForm');
      const msgs = document.getElementById('mensagens');
      const tbody = document.querySelector('#tabelaProdutos tbody');

      function showMsg(text) { msgs.textContent = text; }
      function formToJSON() {
        return JSON.stringify({
          id: document.getElementById('id').value || 0,
          nome: document.getElementById('nome').value,
          preco: parseFloat(document.getElementById('preco').value),
          quantidade: parseInt(document.getElementById('quantidade').value, 10)
        });
      }
      function limparForm() { form.reset(); }

      async function listarProdutos() {
        try {
          const response = await fetch(API_URL);
          if (!response.ok) throw new Error('Erro ao buscar produtos: ' + response.statusText);
          const produtos = await response.json();
          
          tbody.innerHTML = '';
          produtos.forEach(p => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${p.id}</td>
              <td>${p.nome}</td>
              <td>${Number(p.preco).toFixed(2)}</td>
              <td>${p.quantidade}</td>
              <td>
                <button onclick="carregarProduto(${p.id},'${p.nome}',${p.preco},${p.quantidade})">Carregar</button>
              </td>
            `;
            tbody.appendChild(tr);
          });
        } catch (error) {
          showMsg('Erro: ' + error.message);
        }
      }

      window.carregarProduto = function(id, nome, preco, quantidade) {
        document.getElementById('id').value = id;
        document.getElementById('nome').value = nome;
        document.getElementById('preco').value = preco;
        document.getElementById('quantidade').value = quantidade;
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
          const response = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: formToJSON()
          });
          if (!response.ok) throw new Error('Erro ao salvar produto.');
          limparForm();
          listarProdutos();
          showMsg('Produto salvo com sucesso!');
        } catch (error) {
          showMsg('Erro: ' + error.message);
        }
      });
      
      document.getElementById('btnAtualizar').addEventListener('click', async () => {
        const id = document.getElementById('id').value;
        if (!id) {
          showMsg('Por favor, carregue um produto para atualizar.');
          return;
        }
        try {
          const response = await fetch(`${API_URL}/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: formToJSON()
          });
          if (!response.ok) throw new Error('Erro ao atualizar produto.');
          limparForm();
          listarProdutos();
          showMsg('Produto atualizado com sucesso!');
        } catch (error) {
          showMsg('Erro: ' + error.message);
        }
      });

      document.getElementById('btnExcluir').addEventListener('click', async () => {
        const id = document.getElementById('id').value;
        if (!id) {
          showMsg('Por favor, carregue um produto para excluir.');
          return;
        }
        if (!confirm('Tem certeza que deseja excluir o produto com ID ' + id + '?')) return;
        try {
          const response = await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
          if (!response.ok) throw new Error('Erro ao excluir produto.');
          limparForm();
          listarProdutos();
          showMsg('Produto excluído com sucesso!');
        } catch (error) {
          showMsg('Erro: ' + error.message);
        }
      });
      
      document.getElementById('btnLimpar').addEventListener('click', limparForm);

      listarProdutos();
    })();
  </script>
</body>
</html>